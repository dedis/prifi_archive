Trap-encoding Design
====================
The owner of a scheduled DC-net cell trap-encodes the cell's cleartext data
before transmitting it anonymously via DC-nets.

Trap-encoding logically consists of the following abstract procedures:

Trustees
---
- `SessionInit`: At the start of a session (after the shuffle), each
    trustee runs TrapInit to form a Diffie-Hellman secret between itself and
    each anonymous slot-owner key that emerged from the shuffle.
- `Check`: after an interval has completed, the relay sends the trustees
    (perhaps in the background) a transcript of the results of all
    communication during the interval, and the trustees run TrapCheck on each
    cell to ensure that no trap-bits were flipped (indicating DC-nets
    disruption).

Clients
---
- `SessionInit`: The private key corresponding to the slot owned by this client
    is stored
- `IntervalInit`: The shared secrets, noise generator, and trap bit position
    generator are established.
- `EncodeCell`: the owner of a given cell can optionally run the `EncodeCell`
    procedure to transmit useful data in the cell's transmission slot.

Relay
---
- `TrapDecode`: once the relay collects the clients' DC-net
    ciphertexts for a given cell from each of the clients online in this
    interval, and combines them with the trustees' DC-net ciphertexts for that
    cell, the relay uses TrapDecode to extract the cell's cleartext content.

`Trap.Trustee.SessionInit(SID,Kt,[K'o]) -> (SM, [Commits])`
---
Runs on trustee after a shuffle, to compute shared secrets between trustees and
slot owners.

### inputs:
- `SID`: session ID of this session
- `Kt`: this trustee's well-known private key
- `[K'o]`: list of public owner-keys that came out of the shuffle.

### outputs:
- `SM`: a map from each `K'o` in the shuffle's output to a trap-encoding secret
    shared between trustee `t` and owner `o`
- `[Commits]`: a list of commitments to trap-encoding secrets, one for each
    owner `o` in the same order as shuffle output.

`Trap.Client.SessionInit(Ko) -> ()`
---
Runs on client at the beginning of a session. Initializes this client's slot
owner private key.

### inputs:
- `Ko`: The slot owner private key

`Trap.Client.IntervalInit([Sto]) -> ([Tt],T,N,R)`
---
Runs on client at the beginning of an interval to establish the Noise and trap
bit position generators for this interval.
Note that the seed of each pseudorandom generator produced is based on a unique
identifier for this interval. This means that as long as the same pair of
generators is passed to `EncodeCell` for each cell of this interval, and as long
as cells are always processed in order, it is unnecessary to additionally keep
track of an index to the current cell.

### inputs:
- `[Sto]`: List of per-session shared secrets for trap encoding, established at
    the DC-nets layer. `Sto` is the interval shared secret between trustee `t`
    and slot owner `o`.

### outputs:
- `[Tt]`: a list of per-interval trap-secrets shared between this slot owner
    and each trustee `t`. `Tt = h^Sto`, where `h` is
    `H{SID, FirstCell, "IntervalInit"}`
- `T`: The composite trap-secret for this interval, a hash of `H{T1,...,Tn}`
    for all `Ti` in `[Tt]`
- `N`: A pseudorandom generator seeded with `H{T, "Noise"}`; used to generate
    noise for this interval
- `R`: A pseudorandom generator seeded with `H{T, "Position"}`; used to generate
    trap bit positions for this interval

`Trap.Client.EncodeCell(Payload,N,R,Wordsize) -> ([Chunk_i],[Inv_i])`
---
Runs on a client each time it wants to put data in a cell

### inputs:
- `Payload`: A message to encode
- `N`: The noise generator from `Trap.Client.IntervalInit`
- `R`: The position generator from `Trap.Client.IntervalInit`
- `Wordsize`: The number of bits per output chunk. One in every `Wordsize` bits
    is a trap bit.

### outputs
- `[Chunk_i]`: A list of encoded chunks of the payload. If `p` is the `i`th
    number between 0 and `Wordsize` generated by `R`, then the `p`th bit of
    `Chunk_i` must be equal to the `p`th bit of the `i`th `Wordsize`-bit chunk
    produced by `N`.
- `[Inv_i]`: A list of bits. `Inv_i` is 1 if and only if `Chunk_i` had to be
    inverted to get the trap bit to match the noise chunk in that position.

`Trap.Relay.Decode([Chunk_i],[Inv_i]) -> (DecodedPayload)`:
---
Runs on relay once all ciphertext from clients and trustees has been collected
for this cell.

### inputs:
- `[Chunk_i]`: A list of encoded chunks of the payload (the output of
    `EncodeCell`)
- `[Inv_i]`: The list of inversion bits from `EncodeCell`

### outputs:
- `DecodedPayload`: The original payload for this cell (the `Payload` argument
    to `EncodeCell`). Generated by inverting the elements of `[Chunk_i]` that
    correspond to 1-bits in `[Inv_i]` and concatenating the results.

`Trap.Trustee.Check(h,[To],[([Chunk_ci]|[Inv_ci])]) -> (ok, Other)`:
---
Runs on all trustees after the end of an interval, after all trap-encoding
secrets have been revealed

### inputs:
- `h`: The well known hash for this interval (`H{SID, FirstCell,
    "IntervalInit"`)
- `[To]'`: List of composite per-interval trap secrets for each slot owner `o`.
    `To` is `H{To1,...,Ton}`, where `Toj` is the per-interval trap encoding
    secret between `o` and trustee `j`.
- `[([Chunk_ci]|[Inv_ci])]`: The encoded cleartext in each cell `c` (with
    `[Chunk_ci]` and `[Inv_ci]` as defined in `EncodeCell`)

### outputs:
- `ok`: a boolean indicating whether or not all trap bits were correct.
    Generated by re-computing the pseudorandom generators `N` and `R` from
    `IntervalInit`, and re-generating the noise and trap bit positions to
    compare to the encoded chunks transmitted.
- `Other`: Any other information necessary for starting the blame process
    (TODO)
